<!DOCTYPE html>
<html>
<head>
  <base target="_top">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">  
<title>Dashboard | EMAWave</title>
<link rel="stylesheet" href="styles.css">
  
</head>
<body>
<!-- ================= DASHBOARD ================= -->
<main>

  <!-- ===== Snapshot Card + Ticker ===== -->
  <div class="card">
    <h2>
      <div class="status-bubble" onclick="toggleStatusPanel()">
        Dashboard: <span id="snapshotEmail"></span> | 
        Visits: <span id="snapshotVisits"></span>
      </div>
    </h2>

    <!-- ===== Scrolling Market Ticker INSIDE CARD ===== -->
    <div class="ticker-wrapper" style="margin-top:12px;">
      <iframe 
        height="60"
        style="width:100%; border:none; border-radius:8px;"
        src="https://s.tradingview.com/embed-widget/ticker-tape/?locale=en#%7B%22symbols%22%3A%5B%7B%22proName%22%3A%22OANDA%3AXAUUSD%22%2C%22title%22%3A%22Gold%22%7D%2C%7B%22proName%22%3A%22OANDA%3AUS30USD%22%2C%22title%22%3A%22US30%22%7D%2C%7B%22proName%22%3A%22BINANCE%3ABTCUSDT%22%2C%22title%22%3A%22BTC%22%7D%5D%2C%22colorTheme%22%3A%22dark%22%7D">
      </iframe>
    </div>
  </div>

  <!-- ===== Trading Panel ===== -->
  <div class="dashboard-layout">

    <!-- LEFT SIDE: YOUTUBE VIDEO -->
    <div class="video-column">
      <iframe 
        src="https://www.youtube.com/embed/a2-2LygDwv0?si=9w9KOrUnXQJq4aVF" 
        allowfullscreen>
      </iframe>
    </div>

    <!-- RIGHT SIDE: TRADE PANEL + CALENDAR -->
    <div class="side-column">

      <!-- TRADE PANEL -->
      <div class="card trade-panel">
        <h3>Every trade position you make will auto close based on TP and SL that is calculated for you, or you may manually close each position by clicking close.</h3>

        <div id="passwordBox" style="display:none;">
          <input type="password" id="newPassword" placeholder="Create trading password">
          <button onclick="Login.setPassword()">Set Password</button>
        </div>

        <div id="openTrades"></div>

        <div class="trade-buttons">
          <button class="long" onclick="TradeEngine.execute('LONG')">LONG +1 MARKET</button>
          <button class="short" onclick="TradeEngine.execute('SHORT')">SHORT +1 MARKET</button>
          <button class="close" onclick="TradeEngine.execute('CLOSE')">CLOSE</button>
        </div>

        <div id="message" style="margin-top:12px;"></div>
        <div id="prices"></div>
      </div>

      <!-- ===== User Daily P/L Calendar (Dynamic) ===== -->
      <div class="card calendar-panel">
        <div class="calendar-header">
          <h3>My Daily P/L Calendar</h3>
          <div>Balance: $<span id="snapshotBalance">0.00</span></div>
        </div>
        
        <div id="my-calendar">
          <p>Loading your daily P/L...</p>
        </div>
      </div>

    </div>
  </div>

    <div style="display:flex; justify-content:center; gap:60px; margin-top:50px;">
    <div style="text-align:center;">
      <a href="affiliate.html"
        style="color:#4da3ff; font-weight:bold; text-decoration:none;">
        Affiliate Lab â†’
      </a>
    </div>

    <div style="text-align:center;">
      <a href="copytrader.html"
        style="color:#4da3ff; font-weight:bold; text-decoration:none;">
        Copy Trader â†’
      </a>    
    </div>
  </div>
</main>

<!-- ================= AFFILIATE ================= -->
<main>
  <h2>Affiliate Program</h2>

  <div class="card">
    <div>Your Referral Link:</div>
    <div id="refLink"></div>
  </div>

  <button onclick="Sections.show('dashboard')">Back</button>
</main>
  
<script>

// ================= TRADES =================

function updateButtons() {
  document.querySelector('.long').disabled = tradeState.active;
  document.querySelector('.short').disabled = tradeState.active;
  document.querySelector('.close').disabled = !tradeState.active;
}

// ================= GLOBAL STATE =================
const AppState = {
  currentUser: null,
  trade: {
    active: false,
    tradeId: null,
    entry: null,
    side: null
  }
};

// ================= SECTION CONTROLLER =================
const Sections = {
  show(id) {
    document.querySelectorAll('section')
      .forEach(s => s.classList.remove('active'));

    const el = document.getElementById(id);
    if (el) el.classList.add('active');
  }
};

// ================= UI HELPERS =================
const UI = {

  setMessage(msg) {
    const el = document.getElementById('message');
    if (el) el.innerText = msg;
  },

  setPrices(text) {
    const el = document.getElementById('prices');
    if (el) el.innerText = text;
  },

  setBalance(val) {
    const el = document.getElementById('snapshotBalance');
    if (el) el.innerText = Number(val).toFixed(2);
  },

  showTradeBlocked() {
    const el = document.getElementById('openTrades');
    if (!el) return;

    el.innerHTML = `
      <div class="trade-locked">
        ðŸ”’ Trading Locked<br>
        Create a password to enable trading.
      </div>
    `;
  }
};

// ================= AUTH =================
const Auth = {

  canTrade() {
    return localStorage.getItem('jarvis_has_password') === '1';
  },

  setPasswordStatus(user) {
    localStorage.setItem(
      'jarvis_has_password',
      user.Password ? '1' : '0'
    );
  }
};

// ================= LOGIN =================
const Login = {

  start() {
    const email = document.getElementById('emailInput').value;
    if (!email) return alert("Enter email");

    localStorage.setItem('jarvis_email', email);
    localStorage.setItem('jarvis_logged_in', '1');

    google.script.run
      .withSuccessHandler(user => {
        if (!user) return;
        AppState.currentUser = user;
        Auth.setPasswordStatus(user);
        Dashboard.load(user);
        Sections.show('dashboard');
      })
      .getOrCreateUser(email, getVisitorId());
  },

  setPassword() {
    const pwd = document.getElementById('newPassword').value;
    if (!pwd) return alert("Enter password");

    google.script.run
      .withSuccessHandler(() => {
        localStorage.setItem('jarvis_has_password', '1');
        document.getElementById('passwordBox').style.display = 'none';
        document.getElementById('openTrades').innerHTML = '';
      })
      .setUserPassword(AppState.currentUser.UserID, pwd);
  }
};

// ================= TRADE ENGINE =================
const TradeEngine = {

  updateButtons() {
    document.querySelector('.long').disabled = AppState.trade.active;
    document.querySelector('.short').disabled = AppState.trade.active;
    document.querySelector('.close').disabled = !AppState.trade.active;
  },

  execute(action) {

    if (!Auth.canTrade()) {
      UI.showTradeBlocked();
      return;
    }

    UI.setMessage("Processing...");

    google.script.run
      .withSuccessHandler(res => {

        UI.setMessage(res.message);

        if (res.state === 'OPEN') {
          Object.assign(AppState.trade, {
            active: true,
            tradeId: res.tradeId,
            entry: res.entry,
            side: res.side
          });

          UI.setPrices(`Entry: ${res.entry} | SL: ${res.sl} | TP: ${res.tp}`);
        }

        if (res.state === 'CLOSED') {
          AppState.trade = { active:false, tradeId:null, entry:null, side:null };

          UI.setPrices(
            `Closed @ ${Number(res.exit).toFixed(2)} | P/L: $${Number(res.pl).toFixed(2)}`
          );

          if (res.balance !== undefined)
            UI.setBalance(res.balance);
        }

        this.updateButtons();
      })
      .withFailureHandler(err => UI.setMessage(err.message))
      .handleTradeAction({
        action,
        userId: AppState.currentUser.UserID,
        tradeId: AppState.trade.tradeId
      });
  }
};

// ================= DASHBOARD =================
const Dashboard = {

  load(user) {

    AppState.currentUser = user;

    document.getElementById('snapshotEmail').innerText = user.Email || 'Guest';
    document.getElementById('snapshotVisits').innerText = user.Visits || '0';

    if (!user.Password) {
      document.getElementById('passwordBox').style.display = 'block';
      UI.showTradeBlocked();
    }

    google.script.run
      .withSuccessHandler(balance => UI.setBalance(balance))
      .getUserTodayBalance(user.UserID);

    document.getElementById('refLink').innerText =
      window.location.origin + "?ref=" + user.UserID;
  }
};

// ================= UTIL =================
function getVisitorId() {
  let id = localStorage.getItem('jarvis_visitor_id');
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem('jarvis_visitor_id', id);
  }
  return id;
}

// ================= CALENDAR =================
// Called after loadDashboard
// ================= AUTO BOOT =================
window.addEventListener('load', () => {

  const email = localStorage.getItem('jarvis_email');
  const loggedIn = localStorage.getItem('jarvis_logged_in') === '1';

  if (!email || !loggedIn) return;

  google.script.run
    .withSuccessHandler(user => {
      if (!user) return;

      AppState.currentUser = user;
      Auth.setPasswordStatus(user);

      // Load dashboard snapshot
      Dashboard.load(user);

      // Load calendar dynamically
      loadCalendar(user.UserID || user.email);

      Sections.show('dashboard');
    })
    .getOrCreateUser(email, getVisitorId());
});

// ================= CALENDAR LOADER =================
function loadCalendar(userId) {
  const container = document.getElementById('my-calendar');
  container.innerHTML = '<p>Loading your daily P/L...</p>';

  const POINT_VALUE = 5; // MNQ $ per point
  const todayDate = new Date().getDate(); // 1â€“31

  google.script.run.withSuccessHandler(calendarData => {
    if (!calendarData || Object.keys(calendarData).length === 0) {
      container.innerHTML = '<p>No calendar data found.</p>';
      return;
    }

    let html = '<table class="calendar-table">';
    html += '<tr><th>Day</th><th>Points</th><th>$ Value</th></tr>';

    Object.keys(calendarData).sort((a,b) => a-b).forEach(day => {
      const trades = calendarData[day];
      const pts = trades.reduce((sum, p) => sum + p, 0); // sum all trades per day
      const dollarValue = pts * POINT_VALUE;

      let color = pts >= 0 ? '#22c55e' : '#ef4444';
      if (Number(day) === todayDate) color = '#3b82f6'; // highlight today

      html += `<tr>
        <td>${day}</td>
        <td style="color:${color}">${pts.toFixed(2)} pts</td>
        <td style="color:${color}">$${dollarValue.toFixed(2)}</td>
      </tr>`;
    });

    html += '</table>';
    container.innerHTML = html;

  }).getUserCalendar(userId);
}

</script>
</body>
</html>
